<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SPECK – Confronta Spettri</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
  html,body{margin:0;height:100%;background:#111;color:#ecf0f1;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
  #topBar{display:flex;gap:18px;align-items:center;background:#000;padding:10px 20px;position:fixed;top:0;left:0;right:0;z-index:10}
  #topBar label{cursor:pointer;font-weight:bold;color:#1abc9c}
  #chips{flex:1;display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:#444;border-radius:14px;padding:2px 10px;font-size:.8rem;cursor:pointer;transition:.2s}
  .chip:hover{background:#c0392b}
  #ccdWrap canvas{width:100%!important;height:120px;margin-bottom:4px;border:1px solid #555}
  #mainArea{position:absolute;top:56px;bottom:0;left:0;right:0;display:flex;flex-direction:column;overflow:hidden}
  #chartWrap{flex:1 1 auto;padding:10px}
  #ccdWrap{flex:0 0 auto;padding:0 10px 10px 10px;overflow-y:auto}
  canvas{width:100%!important;height:100%!important}
</style>
</head>
<body>
  <div id="topBar">
    <label for="picker" style="font-weight:bold;color:#1abc9c">Aggiungi spettro:</label>
    <select id="picker" style="padding:4px 8px;background:#222;color:#ecf0f1;border:1px solid #555;">
      <option value="" disabled selected>— seleziona —</option>
    </select>

    <button id="btnCCD"
            style="padding:4px 10px;background:#1abc9c;border:none;border-radius:4px;color:#fff;font-weight:bold;cursor:pointer;">
      Mostra&nbsp;CCD
    </button>

    <select id="selA" style="background:#222;color:#ecf0f1;border:1px solid #555;">
      <option value="">Serie A</option>
    </select>
    <select id="selB" style="background:#222;color:#ecf0f1;border:1px solid #555;">
      <option value="">Serie B</option>
    </select>
    <button id="btnSub" style="padding:4px 10px;background:#e67e22;border:none;border-radius:4px;color:#fff;font-weight:bold;cursor:pointer;">
      A − B
    </button>

    <div id="chips"></div>
  </div>

  <div id="mainArea">
    <div id="chartWrap"><canvas id="cmpChart"></canvas></div>
    <div id="ccdWrap" style="display:none;"></div>
  </div>

<script>
// === CONFIG ===
const DATA_DIR  = 'csv_out';
const LIST_FILE = 'titoli.json';
// ==============

const colours=['#e74c3c','#3498db','#1abc9c','#f1c40f','#9b59b6','#e67e22','#2ecc71','#8e44ad'];
let datasets=[];
let ccdMode = false;
const selA=document.getElementById('selA');
const selB=document.getElementById('selB');

const chart=new Chart(document.getElementById('cmpChart').getContext('2d'),{
  type:'line',
  data:{datasets},
  options:{responsive:true,maintainAspectRatio:false,
    scales:{x:{type:'linear',title:{display:true,text:'λ (nm)'}},
            y:{title:{display:true,text:'Intensità (a.u.)'}}},
    plugins:{legend:{position:'bottom'}}}
});

(async function loadList(){
  try{
    const res = await fetch(`${DATA_DIR}/${LIST_FILE}`);
    if(!res.ok) throw new Error();
    const map = await res.json();
    populatePicker(map);
  }catch{
    const dir = await (await fetch(`${DATA_DIR}/`)).text();
    const files=[...dir.matchAll(/href=\"([^"]+\\.csv)\"/gi)].map(m=>decodeURIComponent(m[1]));
    const map = Object.fromEntries(files.map(f=>[f,f]));
    populatePicker(map);
  }
})();

function populatePicker(obj){
  const sel=document.getElementById('picker');
  Object.entries(obj)
        .filter(([f])=>f.toLowerCase().endsWith('.csv'))
        .forEach(([file,title])=>{
          const opt=document.createElement('option');
          opt.value=file; opt.textContent=title||file;
          sel.appendChild(opt);
        });
}

function refreshSelects(){
  [selA,selB].forEach(sel=>{
    const current=sel.value;
    sel.innerHTML='<option value="">'+(sel===selA?'Serie A':'Serie B')+'</option>';
    datasets.forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d.label;
      opt.textContent=d.label;
      sel.appendChild(opt);
    });
    if([...sel.options].some(o=>o.value===current)) sel.value=current;
  });
}

document.getElementById('picker').addEventListener('change',async e=>{
  const file=e.target.value;
  if(!file) return;
  if(datasets.some(d=>d.label===file)) return; // già caricato
  const txt=await (await fetch(`${DATA_DIR}/${file}`)).text();
  const vec=parseCSV(txt);
  if(vec) addDataset(file,vec);
  e.target.selectedIndex=0;   // reset menu
});

function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  if(lines.length<2) return null;
  const headers=lines[0].split(',').map(h=>h.trim());
  const store=Object.fromEntries(headers.map(h=>[h,[]]));
  for(let i=1;i<lines.length;i++){
    const nums=lines[i].split(',').map(parseFloat);
    nums.forEach((v,j)=>!isNaN(v)&&store[headers[j]].push(v));
  }
  return store;
}

function addDataset(name,vec){
  if(!vec) return;
  const keys = Object.keys(vec);
  const wlKey = keys[0];
  const yKey  = keys[1] || wlKey;
  const xs=vec[wlKey], ys=vec[yKey];
  const vecObj = {xs, ys};
  const color=colours[datasets.length%colours.length];
  datasets.push({
    label: vec.title || name,
    data:xs.map((x,i)=>({x,y:ys[i]})),
    borderColor:color,
    pointRadius:0,
    parsing:{xAxisKey:'x',yAxisKey:'y'},
    meta: vecObj            // <— aggiunto
  });
  chart.update();
  makeChip(name);
  refreshSelects();
  if(ccdMode) drawAllCCD();
}

function makeChip(label){
  const chips=document.getElementById('chips');
  const span=document.createElement('span');
  span.className='chip';
  span.textContent='× '+label;
  span.addEventListener('click',()=>{
    datasets=datasets.filter(d=>d.label!==label);
    chart.data.datasets=datasets;
    chart.update();
    span.remove();
    colorInput.remove();
    if(ccdMode) drawAllCCD();
    refreshSelects();
  });
  const colorInput=document.createElement('input');
  colorInput.type='color';
  const ds=datasets.find(d=>d.label===label);
  colorInput.value=ds?ds.borderColor:'#ffffff';
  colorInput.style.marginLeft='6px';
  colorInput.addEventListener('input',e=>{
     const ds=datasets.find(d=>d.label===label);
     if(ds){ds.borderColor=e.target.value;chart.update();}
  });
  chips.appendChild(span);
  chips.appendChild(colorInput);
  refreshSelects();
}

document.getElementById('btnCCD').addEventListener('click',()=>{
  ccdMode = !ccdMode;
  const wrap = document.getElementById('ccdWrap');
  document.getElementById('btnCCD').textContent = ccdMode ? 'Nascondi CCD' : 'Mostra CCD';
  wrap.style.display = ccdMode ? 'block' : 'none';
  if(ccdMode) drawAllCCD();
});

function drawAllCCD(){
  const wrap=document.getElementById('ccdWrap');
  wrap.innerHTML='';
  datasets.forEach(ds=>{
    const {xs,ys}=ds.meta;
    const maxY=Math.max(...ys);
    const cv=document.createElement('canvas');
    cv.width=xs.length; cv.height=120;
    const ctx=cv.getContext('2d');
    ys.forEach((v,i)=>{
      const c=wavelengthToRGB(xs[i],v/maxY);
      ctx.fillStyle=`rgb(${c.r},${c.g},${c.b})`;
      ctx.fillRect(i,0,1,cv.height);
    });
    wrap.appendChild(cv);
  });
}

function wavelengthToRGB(w,f=1){
  let R=0,G=0,B=0;
  if(w>=380&&w<440){R=-(w-440)/60;B=1;}
  else if(w<490){G=(w-440)/50;B=1;}
  else if(w<510){G=1;B=-(w-510)/20;}
  else if(w<580){R=(w-510)/70;G=1;}
  else if(w<645){R=1;G=-(w-645)/65;}
  else if(w<=780){R=1;}
  f=Math.sqrt(f);
  return{r:Math.round(R*255*f),g:Math.round(G*255*f),b:Math.round(B*255*f)};
}

document.getElementById('btnSub').addEventListener('click',()=>{
  const a=selA.value, b=selB.value;
  if(!a||!b||a===b) return;
  const da=datasets.find(d=>d.label===a);
  const db=datasets.find(d=>d.label===b);
  if(!da||!db) return;
  const xs=da.meta.xs;
  if(xs.length!==db.meta.xs.length) { alert('Serie con lunghezze diverse'); return; }
  const ys=xs.map((_,i)=>da.meta.ys[i]-db.meta.ys[i]);
  const label=`${a} - ${b}`;
  if(datasets.some(d=>d.label===label)) return;
  addDataset(label,{0:xs,1:ys,title:label});
});
</script>
</body>
</html>